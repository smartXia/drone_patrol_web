import{_ as X,r as _,m as D,x as j,N as G,b as m,o as S,c as w,e,f as s,w as o,t as c,s as E,G as L,g as f,u as p,W as q,as as F,am as H,an as J,z as K,ae as Q,C as Y}from"./index-e771dba6.js";const Z={class:"live-stream-page"},ee={class:"page-header"},te={class:"stream-info"},se={class:"video-container"},ae={class:"video-wrapper"},oe={key:0,class:"loading-overlay"},le={key:1,class:"error-overlay"},ne={class:"connection-status"},ie={key:0,class:"update-time"},re={class:"control-panel"},ce={class:"card-header"},de={class:"control-buttons"},ue={class:"card-header"},ve={class:"card-header"},pe={class:"playback-status"},_e={class:"status-item"},fe={class:"status-item"},me={class:"status-item"},ye={class:"value"},ge={class:"status-item"},he={class:"value"},R="http://117.62.203.197:8080/rtc/v1/whep/?app=live&stream=8UUXN2B00A00ST-165-0-7",Se={__name:"LiveStream",setup(we){const l=_(null),r=_(!1),d=_(""),u=_(!1),b=_(""),T=_(null),C=_("00:00:00"),y=D(()=>r.value?{type:"warning",text:"连接中..."}:d.value?{type:"danger",text:"连接失败"}:u.value?{type:"success",text:"已连接"}:{type:"info",text:"未连接"}),$=D(()=>l.value&&l.value.videoWidth&&l.value.videoHeight?`${l.value.videoWidth} x ${l.value.videoHeight}`:"未知");let g=null;const N=()=>{T.value=Date.now(),g=setInterval(()=>{if(T.value){const a=Math.floor((Date.now()-T.value)/1e3),t=Math.floor(a/3600),n=Math.floor(a%3600/60),i=a%60;C.value=`${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`}},1e3)},h=()=>{g&&(clearInterval(g),g=null)},k=async()=>{if(l.value){r.value=!0,d.value="",b.value=new Date().toLocaleString();try{await U(),r.value=!1,L.success("直播流连接成功")}catch(a){r.value=!1,d.value=`连接失败: ${a.message}`,L.error("直播流连接失败"),console.error("直播流连接错误:",a)}}},U=async()=>{try{const a=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]});a.ontrack=v=>{console.log("接收到流:",v),v.streams&&v.streams[0]&&(l.value.srcObject=v.streams[0],l.value.play())},a.oniceconnectionstatechange=()=>{console.log("ICE连接状态:",a.iceConnectionState),a.iceConnectionState==="connected"||a.iceConnectionState==="completed"?console.log("WebRTC连接成功"):(a.iceConnectionState==="failed"||a.iceConnectionState==="disconnected")&&(console.log("WebRTC连接失败"),d.value="WebRTC连接失败")};const t=await a.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});await a.setLocalDescription(t);const n=await fetch(R,{method:"POST",headers:{"Content-Type":"application/sdp"},body:t.sdp});if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);const i=await n.text();console.log("收到SDP应答:",i),await a.setRemoteDescription({type:"answer",sdp:i}),console.log("WHEP连接建立成功")}catch(a){throw console.error("WHEP连接错误:",a),a}},W=()=>{h(),C.value="00:00:00",k()},I=()=>{l.value&&(u.value?l.value.pause():l.value.play())},B=()=>{console.log("开始加载视频流")},M=()=>{console.log("视频数据加载完成"),r.value=!1},V=a=>{console.error("视频播放错误:",a),d.value="视频播放出错，请检查网络连接或流地址",r.value=!1,h()},z=()=>{u.value=!0,N(),console.log("开始播放")},A=()=>{u.value=!1,h(),console.log("暂停播放")};return j(()=>{console.log("直播流页面已挂载"),setTimeout(()=>{k()},500)}),G(()=>{h(),l.value&&(l.value.pause(),l.value.src="")}),(a,t)=>{const n=m("el-tag"),i=m("el-icon"),v=m("el-button"),P=m("el-card"),x=m("el-col"),O=m("el-row");return S(),w("div",Z,[e("div",ee,[t[1]||(t[1]=e("h2",null,"直播流播放",-1)),e("div",te,[s(n,{type:"primary"},{default:o(()=>[...t[0]||(t[0]=[f("WHEP协议",-1)])]),_:1}),e("span",{class:"stream-url"},c(R))])]),e("div",se,[e("div",ae,[e("video",{ref_key:"videoElement",ref:l,class:"video-player",controls:"",autoplay:"",muted:"",playsinline:"",onLoadstart:B,onLoadeddata:M,onError:V,onPlay:z,onPause:A}," 您的浏览器不支持视频播放 ",544),r.value?(S(),w("div",oe,[s(i,{class:"loading-icon"},{default:o(()=>[s(p(q))]),_:1}),t[2]||(t[2]=e("p",null,"正在加载直播流...",-1))])):E("",!0),d.value?(S(),w("div",le,[s(i,{class:"error-icon"},{default:o(()=>[s(p(F))]),_:1}),e("p",null,c(d.value),1),s(v,{type:"primary",onClick:W},{default:o(()=>[...t[3]||(t[3]=[f("重试连接",-1)])]),_:1})])):E("",!0),e("div",ne,[s(n,{type:y.value.type,size:"small"},{default:o(()=>[f(c(y.value.text),1)]),_:1},8,["type"]),b.value?(S(),w("span",ie," 最后更新: "+c(b.value),1)):E("",!0)])])]),e("div",re,[s(O,{gutter:16},{default:o(()=>[s(x,{span:8},{default:o(()=>[s(P,{shadow:"hover"},{header:o(()=>[e("div",ce,[s(i,null,{default:o(()=>[s(p(H))]),_:1}),t[4]||(t[4]=e("span",null,"播放控制",-1))])]),default:o(()=>[e("div",de,[s(v,{type:"primary",icon:u.value?p(J):p(H),onClick:I,disabled:r.value||d.value},{default:o(()=>[f(c(u.value?"暂停":"播放"),1)]),_:1},8,["icon","disabled"]),s(v,{type:"info",icon:p(K),onClick:W,loading:r.value},{default:o(()=>[...t[5]||(t[5]=[f(" 重新连接 ",-1)])]),_:1},8,["icon","loading"])])]),_:1})]),_:1}),s(x,{span:8},{default:o(()=>[s(P,{shadow:"hover"},{header:o(()=>[e("div",ue,[s(i,null,{default:o(()=>[s(p(Q))]),_:1}),t[6]||(t[6]=e("span",null,"流信息",-1))])]),default:o(()=>[t[7]||(t[7]=e("div",{class:"stream-details"},[e("div",{class:"detail-item"},[e("span",{class:"label"},"协议:"),e("span",{class:"value"},"WHEP (WebRTC HTTP Egress Protocol)")]),e("div",{class:"detail-item"},[e("span",{class:"label"},"应用:"),e("span",{class:"value"},"live")]),e("div",{class:"detail-item"},[e("span",{class:"label"},"流ID:"),e("span",{class:"value"},"8UUXN2B00A00ST-165-0-7")]),e("div",{class:"detail-item"},[e("span",{class:"label"},"服务器:"),e("span",{class:"value"},"117.62.203.197:8080")])],-1))]),_:1})]),_:1}),s(x,{span:8},{default:o(()=>[s(P,{shadow:"hover"},{header:o(()=>[e("div",ve,[s(i,null,{default:o(()=>[s(p(Y))]),_:1}),t[8]||(t[8]=e("span",null,"播放状态",-1))])]),default:o(()=>[e("div",pe,[e("div",_e,[t[9]||(t[9]=e("span",{class:"label"},"播放状态:",-1)),s(n,{type:u.value?"success":"info",size:"small"},{default:o(()=>[f(c(u.value?"播放中":"已暂停"),1)]),_:1},8,["type"])]),e("div",fe,[t[10]||(t[10]=e("span",{class:"label"},"连接状态:",-1)),s(n,{type:y.value.type,size:"small"},{default:o(()=>[f(c(y.value.text),1)]),_:1},8,["type"])]),e("div",me,[t[11]||(t[11]=e("span",{class:"label"},"视频尺寸:",-1)),e("span",ye,c($.value),1)]),e("div",ge,[t[12]||(t[12]=e("span",{class:"label"},"播放时长:",-1)),e("span",he,c(C.value),1)])])]),_:1})]),_:1})]),_:1})])])}}},Te=X(Se,[["__scopeId","data-v-b1dabd5d"]]);export{Te as default};
